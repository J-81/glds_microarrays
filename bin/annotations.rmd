---
author: "NASA GeneLab Project"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
		      fig.width = 12, 
		      fig.height = 8,
		      error = TRUE # since endpoints include saved data, this is safe as requisite data not being saved will block workflow progression.  This allows a debugger to see the erroring Rmarkdown report.
		      )

# load libraries, could be moved to specific chunks if overloading becomes an issue, but easy to remove load related print outs in this chunk
library(limma)
library(oligo)
library(Biobase)
library(stringr)
keytype<-"PROBEID"

# load required objects from rData files
organism_table <- read.csv(file = file.path(codebase_dir,"organisms.csv"), header = TRUE, stringsAsFactors = FALSE)
load("normalized.RData")
load("raw_data.Rdata")
load("runsheet.RData")# named 'targets'

# set up common variables
count <- dim(targets$t1)[1]
```

# `r targets$glds` Normalized Data QA Summary
#### `r Sys.Date()`
#### Organism: `r targets$organism`
#### Platform: `r targets$platform` Microarray


## Normalized Data Class
```{r normalized-class-listing}
normalized_class <- class(normalized)
print(normalized_class)
```

## Mapping Appropriate Annotation Protocol
``` {r flag-setting, error=FALSE}
flags <- c("expressionset_flag","malist_flag","elist_flag")
flag_state <- data.frame(row.names=flags, criteriaMet=rep(FALSE, times=length(flags)))
flag_state["expressionset_flag",] <- (is(normalized,"ExpressionSet")) # as generated by oligo readcel
flag_state["elist_flag", ] <- (is(normalized,"EList")) # as generated by one channel read.maimages
flag_state["malist_flag", ] <- (is(normalized,"MAList")) # as generated by two channel read.maimages

supported_flags <- sum(flag_state[,"criteriaMet"])

print(flag_state)
```

``` {r check-flags}
if (supported_flags != 1) { 
    stop(sprintf("Error: One and only one flag condition should be met. Flag conditions met: %d,  see flag conditions in this markdown file", supported_flags))
}
```

## Study Sample Factor Grouping
```{r study-sample-factor-grouping, echo=FALSE}
  DT::datatable(targets$t1)
```

## Annotation Mapping Protocol
```{r featureset--box-plots, eval=(flag_state["expressionset_flag",]),  include=(flag_state["expressionset_flag",])}
expression_df <- data.frame(Biobase::exprs(normalized))
keys<-rownames(expression_df)

### Import Probe Data
if (length(targets$probe >= 1)){
  print("Branch: 1")
  options(connectionObserver = NULL)
  database <- sub('\\\\.annotation.tar.gz$', '', basename(targets$probe)) 
  cat("\nLoading local probe annotation database: ",database,"\n")
  if(!require(database, character.only=TRUE)) {
    BiocManager::install(database, ask = FALSE)
  }
  install.packages(targets$probe,repos = NULL, verbose = FALSE, quiet = TRUE)
  library(database, character.only=TRUE)
}else {
  print("Branch: 2")
  package <- raw_data@annotation
  package <- gsub("pd.","",package)
  package <- gsub(".v1","transcriptcluster",package)
  package <- gsub("[.]","",package)
  package <- paste0(package,".db")
  database <- package
  cat("\nSearch for package: ",database)
  if(!require(database, character.only=TRUE)) {
    BiocManager::install(database, ask = FALSE)
  }
  library(database, character.only=TRUE)
}

### Map assay database annotations
annotation <- data.frame(REFSEQ=mapIds(eval(parse(text = database),env=.GlobalEnv),keys = keys,keytype = keytype, column = "REFSEQ",multiVals = "first"))

annotation$ENSEMBL<-mapIds(eval(parse(text = database),env=.GlobalEnv),keys = keys,keytype = keytype, column = "ENSEMBL",multiVals = "first")
annotation$SYMBOL<-mapIds(eval(parse(text = database),env=.GlobalEnv),keys = keys,keytype = keytype, column = "SYMBOL",multiVals = "first")
annotation$GENENAME<-mapIds(eval(parse(text = database),env=.GlobalEnv),keys = keys,keytype = keytype, column = "GENENAME",multiVals = "first")
annotation$ENTREZID<-mapIds(eval(parse(text = database),env=.GlobalEnv),keys = keys,keytype = keytype, column = "ENTREZID",multiVals = "first")
annotation$TAIR<-mapIds(eval(parse(text = database),env=.GlobalEnv),keys = keys,keytype = keytype, column = "TAIR",multiVals = "first")
annotation$GOSLIM_IDS<-mapIds(eval(parse(text = database),env=.GlobalEnv),keys = keys,keytype = keytype, column = "GO",multiVals = "first")


### Map STRING annotations
string_db <- STRINGdb::STRINGdb$new( version="11", species=organism_table$taxon[str_replace(tolower(organism_table$species), " ", "_") == targets$organism] ,score_threshold=0)
string_map<-string_db$map(annotation,"ENTREZID",removeUnmappedRows = TRUE, takeFirst = TRUE)
string_cols <-string_map[,c("ENTREZID","STRING_id")]
string_cols <- string_cols[!duplicated(string_cols$ENTREZID),]
annotation <- dplyr::left_join(annotation,string_cols,by="ENTREZID")
```

```{r list--box-plots, eval=(any(flag_state[c("elist_flag","malist_flag"),])), include=(any(flag_state[c("elist_flag","malist_flag"),]))}
longest_sample_name_length <- max(nchar(rownames(normalized$targets))) * 0.5
bottom_margin <- min(35, longest_sample_name_length)
par(mar=c(bottom_margin,2,1,1))
boxplot(data.frame(log2(as.matrix(normalized))),main="Normalized Data Log2 Intensities", las=2,outline=FALSE)
```

## Export files
```{r export }
### Generate normalized annotated expression text file
cat("\nGenerating normalized-annotated.txt file\n")
expression_df <- cbind(annotation,expression_df)
write.table(expression_df,"normalized-annotated.txt",quote=FALSE, append = FALSE, row.names = FALSE, sep = "\t")
write.table(annotation,"probe_annotations.txt",quote=FALSE, append = FALSE, row.names = FALSE, sep = "\t")

### Annotate the expression set object and save as a file
cat("\nGenerating normalized-annotated.rda file\n")

fData(normalized)<-annotation
save(normalized, file = "normalized-annotated.rda")
```
