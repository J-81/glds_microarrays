---
author: "NASA GeneLab Project"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
		      fig.width = 12, 
		      fig.height = 8,
		      error = TRUE # since endpoints include saved data, this is safe as requisite data not being saved will block workflow progression.  This allows a debugger to see the erroring Rmarkdown report.
		      )

# load libraries, could be moved to specific chunks if overloading becomes an issue, but easy to remove load related print outs in this chunk
library(limma)
library(oligo)

# load required objects from rData files
load("raw_data.RData")
load("targets.RData") # named 'targets'

# set up common variables
count <- dim(targets$t1)[1]
```

# `r targets$glds` Raw Data QA Summary
#### `r Sys.Date()`
#### Organism: `r targets$organism`
#### Platform: `r targets$platform` Microarray


## Raw Data Class
```{r raw-class-listing}
raw_class <- class(raw_data)
print(raw_class)
```

## Mapping Appropriate QA Raw Protocol
``` {r flag-setting, error=FALSE}
flags <- c("featureset_flag","rglist_flag","elistraw_flag")
flag_state <- data.frame(row.names=flags, criteriaMet=rep(FALSE, times=length(flags)))
flag_state["featureset_flag",] <- (is(raw_data,"FeatureSet")) # as generated by oligo readcel
flag_state["elistraw_flag", ] <- (is(raw_data,"EListRaw")) # as generated by one channel read.maimages
flag_state["rglist_flag", ] <- (is(raw_data,"RGList")) # as generated by two channel read.maimages

supported_flags <- sum(flag_state[,"criteriaMet"])

print(flag_state)
```

``` {r check-flags}
if (supported_flags != 1) { 
    stop(sprintf("Error: One and only one flag condition should be met. Flag conditions met: %d,  see flag conditions in this markdown file", supported_flags))
}
```

## Study Sample Factor Grouping
```{r study-sample-factor-grouping, echo=FALSE}
  DT::datatable(targets$t1)
```

## Array Spot Log Intensity Images
```{r featureset--array-spot-log-intensity-images,  eval=(flag_state["featureset_flag",]), include=(flag_state["featureset_flag",])}
for (i in 1:count){
  oligo::image(raw_data, transfo=log2, which=i)
  }
```
```{r lists--array-spot-log-intensity-images,  eval=(any(flag_state[c("elistraw_flag","rglist_flag"),])), include=(any(flag_state[c("elistraw_flag","rglist_flag"),]))}
for (ind in 1:count){
  if (targets$platform == "Agilent"){
      r <- raw_data$genes$Row
      c <- raw_data$genes$Col
      nr <- max(r)
      nc <- max(c)
      i <- (r-1)*nc+c
      y <- rep(NA,length(i))
      y[i] <- log2(raw_data$Eb[,ind])
      raw_data$printer <- list(ngrid.r=1,ngrid.c=1,nspot.r=nr,nspot.c=nc) 
  }
  imageplot(y,raw_data$printer, main=colnames(raw_data$Eb)[ind])
  ## fix imageplot printer columns
}
```

## Raw Data MA Plots
```{r featureset--ma-plots,  eval=(flag_state["featureset_flag",]), include=(flag_state["featureset_flag",])}
for (i in 1:count){
    plotted <- oligo::MAplot(raw_data, which=i, pairs=FALSE, main="\nvs pseudo-median reference chip")
}
```

```{r lists--ma-plots,  eval=(any(flag_state[c("elistraw_flag","rglist_flag"),])), include=(any(flag_state[c("elistraw_flag","rglist_flag"),]))}
count <- dim(targets$t1)[1]
for (i in 1:count){
    limma::plotMD(raw_data, column = i, xlab = "Average log-expression", ylab = "log-fold-change", main = colnames(raw_data)[i])
  }
```

## Raw Data Density Plot
```{r featureset--density-plot, eval=(flag_state["featureset_flag",]),  include=(flag_state["featureset_flag",])}

if (class(raw_data)=="ExonFeatureSet" || class(raw_data)=="GeneFeatureSet"){
  oligo::hist(raw_data, main = paste0(targets$glds," Raw Intensity Distributions"), target="probeset",xlab="Intensity",ylab="Density",col=rainbow(count),lty=1)
  legend("topright",legend=targets$t1$SampleName,fill = rainbow(count))
}else{
  oligo::hist(raw_data, main = paste0(targets$glds," Raw Intensity Distributions"),xlab="Intensity",ylab="Density",col=rainbow(count),lty=1)
  legend("topright",legend=targets$t1$SampleName,fill = rainbow(count))
}

```
```{r list--density-plot, eval=(any(flag_state[c("elistraw_flag","rglist_flag"),])), include=(any(flag_state[c("elistraw_flag","rglist_flag"),]))}
limma::plotDensities(raw_data, legend = FALSE)
legend("topright",legend=targets$t1$SampleName,fill = rainbow(count))

```

## Raw Data Box Plot
```{r featureset--box-plots, eval=(flag_state["featureset_flag",]),  include=(flag_state["featureset_flag",])}
longest_sample_name_length <- max(nchar(sampleNames(raw_data))) * 0.5
bottom_margin <- min(35, longest_sample_name_length)
par(mar=c(bottom_margin,5,5,1))
if (class(raw_data)=="ExonFeatureSet" || class(raw_data)=="GeneFeatureSet"){
oligo::boxplot(raw_data,which="pm",transfo=log2, nsample=10000,main=paste0(targets$glds," Raw Data Log2 Intensities"), las=2,outline=FALSE,ylab = "log2 Intensities", target="probeset")
}else{
oligo::boxplot(raw_data,which="pm",transfo=log2, nsample=10000,main=paste0(targets$glds," Raw Data Log2 Intensities"), las=2,outline=FALSE,ylab = "log2 Intensities")
}
```
```{r list--box-plots, eval=(any(flag_state[c("elistraw_flag","rglist_flag"),])), include=(any(flag_state[c("elistraw_flag","rglist_flag"),]))}
longest_sample_name_length <- max(nchar(rownames(raw_data$targets))) * 0.5
bottom_margin <- min(35, longest_sample_name_length)
par(mar=c(bottom_margin,2,1,1))
boxplot(data.frame(log2(as.matrix(raw_data))),main="Raw Data Log2 Intensities", las=2,outline=FALSE)
```

## Raw Data PCA Plot
```{r rglist--extract-raw-expression-preproc, eval=(flag_state["rglist_flag",]), include=(flag_state["rglist_flag",]) }
raw_data <- limma::backgroundCorrect(raw_data, method="normexp", offset=50,normexp.method="saddle")
cat("\nBackground correction by NormExp\n")
raw_data <- normalizeWithinArrays(raw_data, method="loess", weights = raw_data$weights)
cat("\nWithin Array Normalization by Loess\n")
exp_raw <- log2(as.matrix(raw_data$A))
```

```{r elistraw--extract-raw-expression-preproc, eval=(flag_state["elistraw_flag",]), include=(flag_state["elistraw_flag",]) }
exp_raw <- log2(as.matrix(raw_data))
```

```{r featureset--extract-raw-expression-preproc, eval=(flag_state["featureset_flag",]), include=(flag_state["featureset_flag",]) }
exp_raw <- log2(exprs(raw_data))
```

```{r pca-plot }
library(ggplot2)
PCA_raw <- tryCatch({
	prcomp(t(exp_raw), scale. = TRUE) # scaling will fail for low replicates
}, error = function(e) {
	print(paste("Scaling failed, retrying without scaling. Error Message: ", e))
	prcomp(t(exp_raw), scale. = FALSE)
})
percentVar <- round(100*PCA_raw$sdev^2/sum(PCA_raw$sdev^2),1)
sd_ratio <- sqrt(percentVar[2] / percentVar[1])
dataGG <- data.frame(PC1 = PCA_raw$x[,1], PC2 = PCA_raw$x[,2], Group = targets$t1$Group)
PCA_plot <- ggplot(dataGG, aes(PC1, PC2)) +
      geom_point(aes(colour = Group)) +
  ggtitle("Raw Data PCA Plot of log2 Expression") +
  xlab(paste0("PC1, VarExp: ", percentVar[1], "%")) +
  ylab(paste0("PC2, VarExp: ", percentVar[2], "%"))
plot(PCA_plot)

write.csv(PCA_raw$x, file = "raw_visualization_PCA_table.csv")
```

